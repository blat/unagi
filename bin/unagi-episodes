#!/usr/bin/env python

import sys
import datetime
sys.path.append('/path/to/unagi/')

from unagi.show import Show
from unagi.show import Episode
from unagi.user import User
from database import session

# update episodes
episodes = session.query(Episode).\
    filter(Episode.aired_at < datetime.date.today(),).\
    filter(Episode.status != Episode.STATUS_IGNORED).\
    join(Show.users).all()
for episode in episodes:
    try:
        notify = False
        if (episode.torrent == None):
            episode.queue()
        else:
            if (episode.torrent_percent < 100):
                episode.sync_torrent()
            else:
                if (episode.subtitle_percent < 100):
                    episode.sync_subtitle()
                    notify = True
                else:
                    episode.check_video()
                    episode.check_subtitle()
        if (notify and episode.torrent != None and episode.subtitle_percent >= 100 and episode.torrent_percent >= 100):
            episode.notify()
    except Exception as error:
        print("%s %s" % (episode, error))
